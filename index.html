<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malte Stoepke's Portfolio OS</title>
    <link rel="stylesheet" href="https://unpkg.com/98.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "MS Sans Serif", "Tahoma", Arial, sans-serif;
        }

        body {
            background: #008080 url('https://i.imgur.com/rA9aA2x.png') no-repeat center center fixed; /* Classic Win95 Wallpaper */
            background-size: cover;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .desktop {
            flex-grow: 1;
            padding: 10px;
            position: relative;
            z-index: 1;
        }

        .icon {
            position: absolute;
            text-align: center;
            cursor: pointer;
            padding: 8px;
            width: 90px;
            border: 1px solid transparent;
            user-select: none;
        }
        
        .icon.draggable:hover {
            background: rgba(0, 0, 128, 0.5);
            border: 1px dotted white;
        }

        .icon img {
            width: 32px;
            height: 32px;
            object-fit: contain;
        }

        .icon p {
            color: white;
            text-shadow: 1px 1px black;
            font-size: 11px;
            padding: 2px;
            word-wrap: break-word;
        }
        
        .icon.selected p {
            background-color: #000080;
        }

        .window {
            display: none;
            position: absolute;
            top: 10%;
            left: 10%;
            width: 600px;
            min-width: 250px;
            min-height: 150px;
            max-height: 80%;
            overflow: hidden;
            cursor: default;
            z-index: 10;
            resize: both;
        }

        .window.maximized {
            width: 100% !important;
            height: calc(100vh - 30px) !important;
            top: 0 !important;
            left: 0 !important;
            max-height: none;
            resize: none;
        }

        .window.active {
            display: flex;
            flex-direction: column;
        }
        
        .title-bar {
            cursor: move;
        }

        .window-body {
            padding: 8px;
            background: #dfdfdf;
            height: 100%;
            overflow: auto;
            font-size: 12px;
            flex-grow: 1;
        }

        .window-body img.artwork-image {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 8px auto;
            border: 2px inset #ffffff;
        }
        
        .taskbar {
            height: 30px;
            background: #c0c0c0;
            border-top: 2px solid #ffffff;
            display: flex;
            align-items: center;
            padding: 0 2px;
            position: relative;
            z-index: 100;
            flex-shrink: 0;
        }

        .start-button {
            font-weight: bold;
            padding: 2px 6px;
            height: 26px;
            display: flex;
            align-items: center;
        }

        .start-button img {
            width: 20px;
            height: 20px;
            margin-right: 4px;
        }
        
        .taskbar-time {
            font-size: 11px;
            padding: 2px 4px;
            border: 1px solid #808080;
            border-right: 2px solid #fff;
            border-bottom: 2px solid #fff;
            min-width: 80px;
            text-align: center;
            margin-left: 4px;
        }
        
        .taskbar-user {
             font-size: 11px;
             padding: 2px 6px;
             border: 1px solid #808080;
             margin: 0 2px;
        }

        .taskbar-apps {
            display: flex;
            flex-grow: 1;
            margin: 0 4px;
            gap: 2px;
            overflow: hidden;
        }

        .taskbar-app {
            padding: 2px 6px;
            font-size: 12px;
            cursor: pointer;
            max-width: 150px;
            min-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex-shrink: 1;
        }
        
        .start-menu {
            display: none;
            position: absolute;
            bottom: 30px;
            left: 0;
            width: 200px;
            background: #c0c0c0;
            border-top: 2px solid #ffffff;
            border-left: 2px solid #ffffff;
            border-right: 2px solid #000;
            border-bottom: 2px solid #000;
            z-index: 1000;
        }

        .start-menu.active {
            display: block;
        }

        .start-menu ul {
            list-style: none;
            padding: 2px;
            margin: 0;
        }

        .start-menu li {
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
        }

        .start-menu li img {
            width: 22px;
            height: 22px;
            margin-right: 8px;
        }

        .start-menu li:hover {
            background: #000080;
            color: white;
        }
        
        .start-menu-separator {
            height: 1px;
            background: #808080;
            border-bottom: 1px solid #fff;
            margin: 4px 0;
        }

        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #008080;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .login-box {
            background: #c0c0c0;
            padding: 20px;
            width: 320px;
            text-align: center;
        }
        
        .login-field {
            margin: 12px 0;
            text-align: left;
        }
        
        .login-field label {
            display: block;
            margin-bottom: 4px;
            font-size: 12px;
        }

        .login-field input {
             width: 100%;
             padding: 4px;
        }
        
        .login-buttons {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }

        .paint-canvas {
            border: 1px solid black;
            background: white;
            cursor: crosshair;
            display: block;
            margin: 0 auto;
        }
        
        .minesweeper-board {
            display: grid;
            gap: 1px;
            background: #808080;
            padding: 8px;
            border: 2px inset #fff;
            margin: 0 auto;
        }

        .minesweeper-cell {
            width: 20px;
            height: 20px;
            background: #c0c0c0;
            border: 2px outset #fff;
            text-align: center;
            line-height: 16px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .minesweeper-cell.revealed {
            border: 1px solid #808080;
        }
        
        .minesweeper-cell.mine {
            background-color: red;
        }
        
        .color-1 { color: blue; }
        .color-2 { color: green; }
        .color-3 { color: red; }
        .color-4 { color: navy; }
        .color-5 { color: maroon; }
        .color-6 { color: teal; }
        .color-7 { color: black; }
        .color-8 { color: gray; }

        .context-menu {
            position: absolute;
            background: #c0c0c0;
            border-top: 2px solid #ffffff;
            border-left: 2px solid #ffffff;
            border-right: 2px solid #000;
            border-bottom: 2px solid #000;
            z-index: 10000;
            font-size: 12px;
            padding: 2px;
            display: none;
        }

        .context-menu ul {
            list-style: none;
        }

        .context-menu li {
            padding: 4px 18px;
            cursor: pointer;
        }

        .context-menu li:hover {
            background: #000080;
            color: white;
        }

        .ie-toolbar {
            background: #c0c0c0;
            border-bottom: 1px solid #808080;
            padding: 4px;
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .ie-address-bar {
            display: flex;
            align-items: center;
            margin: 4px;
            background: #c0c0c0;
            border-bottom: 1px solid #808080;
            padding: 2px;
        }

        .ie-address-bar label {
            margin-right: 4px;
            font-size: 12px;
            color: #808080;
        }

        .ie-address-bar input {
            flex-grow: 1;
            background: white;
            padding: 4px;
        }
        
        .ie-content {
            background: white;
            padding: 8px;
            height: 100%;
            overflow: auto;
        }
        
        .blog-post {
            border-bottom: 1px solid #c0c0c0;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        
        .blog-post h3 {
            margin: 0 0 5px;
            font-size: 16px;
        }
        
        .blog-post .date {
            font-size: 11px;
            color: #808080;
            margin-bottom: 5px;
        }

        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20000;
            color: white;
        }
        
         #loading-screen p {
            margin-top: 10px;
         }
    </style>
</head>
<body>

    <audio id="startup-sound" src="https://orangefreesounds.com/wp-content/uploads/2022/05/Windows-95-startup-sound.mp3" preload="auto"></audio>
    <audio id="error-sound" src="https://orangefreesounds.com/wp-content/uploads/2020/09/Windows-95-error-sound.mp3" preload="auto"></audio>
    
    <div id="loading-screen">
        <img src="https://win98icons.alexmeub.com/icons/png/windows-0.png" alt="Windows Logo" width="64" height="64">
        <p>Portfolio OS is starting up...</p>
    </div>

    <div id="login-screen">
        <div class="window" style="display: block; width: 340px; top: 30%; left: calc(50% - 170px);">
            <div class="title-bar">
                <div class="title-bar-text">Welcome to Portfolio OS</div>
            </div>
            <div class="window-body">
                <div class="login-box">
                    <img src="https://win98icons.alexmeub.com/icons/png/keys-4.png" alt="Keys" width="48" height="48" style="margin-bottom: 10px;">
                    <p style="margin-bottom: 15px;">Enter a user name and password to log on.</p>
                    <div class="login-field">
                        <label for="username"><u>U</u>ser name:</label>
                        <input type="text" id="username" value="Malte Stoepke">
                    </div>
                    <div class="login-field">
                        <label for="password"><u>P</u>assword:</label>
                        <input type="password" id="password" value="Maus_123">
                    </div>
                    <div class="login-buttons field-row" style="justify-content: center;">
                        <button onclick="login()"><img src="https://win98icons.alexmeub.com/icons/png/key-2.png" style="width:16px; height:16px; margin-right: 5px;">Log On</button>
                        <button onclick="guestLogin()">Guest</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="desktop" id="desktop">
        <div class="icon" data-id="my-computer" style="left: 20px; top: 20px;" ondblclick="openWindow('my-computer-window')">
            <img src="https://win98icons.alexmeub.com/icons/png/computer-4.png" alt="My Computer">
            <p>My Computer</p>
        </div>
        <div class="icon" data-id="portfolio" style="left: 20px; top: 100px;" ondblclick="openWindow('portfolio-window')">
            <img src="https://win98icons.alexmeub.com/icons/png/directory_closed-4.png" alt="Portfolio">
            <p>My 3D Art</p>
        </div>
        <div class="icon" data-id="ie" style="left: 20px; top: 180px;" ondblclick="openWindow('ie-window')">
            <img src="https://win98icons.alexmeub.com/icons/png/msie2-0.png" alt="Internet Explorer">
            <p>Blog</p>
        </div>
        <div class="icon" data-id="about" style="left: 20px; top: 260px;" ondblclick="openWindow('about-window')">
            <img src="https://win98icons.alexmeub.com/icons/png/notepad_file-1.png" alt="About">
            <p>About Me.txt</p>
        </div>
        </div>
    
    <div class="window" id="my-computer-window" style="width: 400px; height: 300px;">
        <div class="title-bar">
            <div class="title-bar-text">My Computer</div>
            <div class="title-bar-controls">
                <button aria-label="Minimize"></button>
                <button aria-label="Maximize"></button>
                <button aria-label="Close"></button>
            </div>
        </div>
        <div class="window-body">
            <div class="icon" ondblclick="openWindow('portfolio-window')">
                <img src="https://win98icons.alexmeub.com/icons/png/directory_closed-4.png" alt="Portfolio">
                <p>My 3D Art</p>
            </div>
        </div>
    </div>
    
    <div class="window" id="portfolio-window" style="width: 500px; height: 400px;">
        <div class="title-bar">
            <div class="title-bar-text">My 3D Art</div>
            <div class="title-bar-controls">
                <button aria-label="Minimize"></button>
                <button aria-label="Maximize"></button>
                <button aria-label="Close"></button>
            </div>
        </div>
        <div class="window-body" id="portfolio-content">
            </div>
    </div>
    
    <div class="window" id="ie-window" style="width: 700px; height: 500px;">
        <div class="title-bar">
            <div class="title-bar-text">My Personal Blog - Internet Explorer</div>
            <div class="title-bar-controls">
                <button aria-label="Minimize"></button>
                <button aria-label="Maximize"></button>
                <button aria-label="Close"></button>
            </div>
        </div>
        <div class="ie-toolbar">
            <button disabled>Back</button>
            <button disabled>Forward</button>
            <button onclick="document.getElementById('error-sound').play()">Stop</button>
            <button onclick="loadBlogPosts()">Refresh</button>
            <button onclick="document.getElementById('error-sound').play()">Home</button>
        </div>
        <div class="ie-address-bar">
            <label>Address:</label>
            <input type="text" value="C:\My Documents\Blog.htm" readonly>
        </div>
        <div class="ie-content" id="blog-content">
            </div>
    </div>
    
    <div class="window" id="about-window" style="width: 400px; height: 250px;">
        <div class="title-bar">
            <div class="title-bar-text">About Me.txt - Notepad</div>
            <div class="title-bar-controls">
                <button aria-label="Minimize"></button>
                <button aria-label="Maximize"></button>
                <button aria-label="Close"></button>
            </div>
        </div>
        <div class="window-body" style="background: white; font-family: 'Lucida Console', monospace;">
            <p><strong>Malte Stoepke - 3D Artist</strong></p>
            <br>
            <p>Welcome to my interactive portfolio!</p>
            <p>This project combines my passion for 3D art with a love for retro computing aesthetics. All artworks displayed here are my own creations.</p>
            <br>
            <p>Log in with the provided credentials to add new artworks or write a blog post.</p>
        </div>
    </div>
    
    <div class="window" id="paint-window" style="width: 500px; height: 400px;">
        <div class="title-bar">
            <div class="title-bar-text">untitled - Paint</div>
            <div class="title-bar-controls">
                <button aria-label="Minimize"></button>
                <button aria-label="Maximize"></button>
                <button aria-label="Close"></button>
            </div>
        </div>
        <div class="window-body">
            <canvas id="paint-canvas" width="480" height="320"></canvas>
        </div>
    </div>
    
    <div class="window" id="pixelsweeper-window" style="width: auto; height: auto;">
        <div class="title-bar">
            <div class="title-bar-text">PixelSweeper</div>
            <div class="title-bar-controls">
                <button aria-label="Minimize"></button>
                <button aria-label="Close"></button>
            </div>
        </div>
        <div class="window-body">
            <div id="minesweeper-board"></div>
        </div>
    </div>

    <div class="window" id="add-artifact-window" style="width: 400px; height: 350px;">
        <div class="title-bar">
            <div class="title-bar-text">Add New Artifact</div>
            <div class="title-bar-controls">
                 <button aria-label="Close"></button>
            </div>
        </div>
        <div class="window-body" style="display:flex; flex-direction: column; gap: 10px;">
             <label for="artifact-title">Title:</label>
             <input type="text" id="artifact-title">
             <label for="artifact-desc">Description:</label>
             <textarea id="artifact-desc" rows="4"></textarea>
             <label for="artifact-image">Image:</label>
             <input type="file" id="artifact-image" accept="image/*">
             <button onclick="addArtwork()">Add Artifact</button>
        </div>
    </div>
    
    <div class="window" id="add-post-window" style="width: 500px; height: 400px;">
        <div class="title-bar">
            <div class="title-bar-text">Add New Blog Post</div>
            <div class="title-bar-controls">
                 <button aria-label="Close"></button>
            </div>
        </div>
        <div class="window-body" style="display:flex; flex-direction: column; gap: 10px;">
             <label for="post-title">Title:</label>
             <input type="text" id="post-title">
             <label for="post-content">Content:</label>
             <textarea id="post-content" rows="8"></textarea>
             <button onclick="addBlogPost()">Publish Post</button>
        </div>
    </div>
    
    <div class="context-menu" id="context-menu">
        <ul>
            <li id="context-delete">Delete</li>
        </ul>
    </div>
    
    <div class="taskbar">
        <button class="start-button" id="start-button">
            <img src="https://win98icons.alexmeub.com/icons/png/windows-0.png" alt="Start">
            <span>Start</span>
        </button>
        <div class="taskbar-apps" id="taskbar-apps"></div>
        <div class="taskbar-user" id="taskbar-user">Guest</div>
        <div class="taskbar-time" id="taskbar-time"></div>
    </div>
    
    <div class="start-menu" id="start-menu">
        <ul>
            <li onclick="openWindow('portfolio-window')"><img src="https://win98icons.alexmeub.com/icons/png/directory_closed-4.png">My 3D Art</li>
            <li onclick="openWindow('ie-window')"><img src="https://win98icons.alexmeub.com/icons/png/msie2-0.png">Blog</li>
            <li id="add-artifact-menu" onclick="openWindow('add-artifact-window')" style="display: none;"><img src="https://win98icons.alexmeub.com/icons/png/paint_file-0.png">Add New Artifact</li>
            <li class="start-menu-separator"></li>
            <li onclick="openWindow('paint-window')"><img src="https://win98icons.alexmeub.com/icons/png/paint-0.png">Paint</li>
            <li onclick="openWindow('pixelsweeper-window')"><img src="https://win98icons.alexmeub.com/icons/png/minesweeper-2.png">PixelSweeper</li>
            <li class="start-menu-separator"></li>
            <li id="login-logout-button" onclick="logout()"><img src="https://win98icons.alexmeub.com/icons/png/keys-4.png">Log Out</li>
        </ul>
    </div>
    
    <script>
    // --- State & Config ---
    let db;
    let currentUser = 'Guest';
    let activeWindow = null;
    let openWindows = {};
    let highestZIndex = 10;
    
    const correctUsername = "Malte Stoepke";
    const correctPassword = "Maus_123";

    // --- DOM Elements ---
    const desktop = document.getElementById('desktop');
    const taskbarApps = document.getElementById('taskbar-apps');
    const startMenu = document.getElementById('start-menu');
    const loginScreen = document.getElementById('login-screen');
    const loadingScreen = document.getElementById('loading-screen');
    const contextMenu = document.getElementById('context-menu');
    
    // --- Initialization ---
    window.onload = () => {
        // Hide loading screen after a delay
        setTimeout(() => {
            loadingScreen.style.display = 'none';
            document.getElementById('startup-sound').play().catch(e => console.log("Audio autoplay blocked."));
        }, 1500);
        
        initDB();
        updateClock();
        setInterval(updateClock, 1000);
        setupEventListeners();
        initPixelSweeper();
        initPaint();
    };

    function initDB() {
        const request = indexedDB.open('PortfolioOSDB', 1);

        request.onerror = (event) => console.error("Database error: ", event.target.errorCode);
        request.onsuccess = (event) => {
            db = event.target.result;
            console.log("Database opened successfully.");
            loadArtworks();
            loadBlogPosts();
        };
        request.onupgradeneeded = (event) => {
            let db = event.target.result;
            db.createObjectStore('artworks', { keyPath: 'id', autoIncrement: true });
            db.createObjectStore('blogPosts', { keyPath: 'id', autoIncrement: true });
        };
    }
    
    function setupEventListeners() {
        // Start Menu
        document.getElementById('start-button').addEventListener('click', (e) => {
            e.stopPropagation();
            startMenu.classList.toggle('active');
        });

        document.addEventListener('click', () => {
            startMenu.classList.remove('active');
            contextMenu.style.display = 'none';
        });
        
        // Window Controls
        document.querySelectorAll('.window').forEach(win => {
            const winId = win.id;
            const titleBar = win.querySelector('.title-bar');
            
            // Dragging
            if (titleBar) {
                titleBar.addEventListener('mousedown', (e) => {
                    if (e.target.closest('.title-bar-controls')) return;
                    startDrag(e, win);
                    bringToFront(winId);
                });
            }

            // Close, Maximize, Minimize
            const controls = win.querySelector('.title-bar-controls');
            if (controls) {
                controls.querySelector('[aria-label="Close"]')?.addEventListener('click', () => closeWindow(winId));
                controls.querySelector('[aria-label="Maximize"]')?.addEventListener('click', () => maximizeWindow(winId));
                controls.querySelector('[aria-label="Minimize"]')?.addEventListener('click', () => minimizeWindow(winId));
            }

            win.addEventListener('mousedown', () => bringToFront(winId));
        });
        
        // Desktop Icon Context Menu
        desktop.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            const icon = e.target.closest('.icon');
            if (currentUser === correctUsername && icon && icon.dataset.type === 'artwork') {
                 showContextMenu(e.clientX, e.clientY, icon.dataset.id);
            }
        });
        contextMenu.addEventListener('click', e => e.stopPropagation());
    }

    // --- Authentication ---
    function login() {
        const user = document.getElementById('username').value;
        const pass = document.getElementById('password').value;

        if (user === correctUsername && pass === correctPassword) {
            currentUser = correctUsername;
            loginScreen.style.display = 'none';
            updateUIAfterLogin();
        } else {
            document.getElementById('error-sound').play();
            alert("Incorrect username or password.");
        }
    }

    function guestLogin() {
        currentUser = 'Guest';
        loginScreen.style.display = 'none';
        updateUIAfterLogin();
    }
    
    function logout() {
        currentUser = 'Guest';
        loginScreen.style.display = 'flex';
        updateUIAfterLogin();
        // Close all windows on logout
        Object.keys(openWindows).forEach(id => closeWindow(id));
    }
    
    function updateUIAfterLogin() {
        document.getElementById('taskbar-user').textContent = currentUser;
        const addArtifactMenu = document.getElementById('add-artifact-menu');
        
        if (currentUser === correctUsername) {
            addArtifactMenu.style.display = 'flex';
            document.getElementById('login-logout-button').innerHTML = `<img src="https://win98icons.alexmeub.com/icons/png/keys-4.png">Log Out`;
            document.getElementById('login-logout-button').onclick = logout;
        } else {
            addArtifactMenu.style.display = 'none';
            document.getElementById('login-logout-button').innerHTML = `<img src="https://win98icons.alexmeub.com/icons/png/keys-4.png">Log In`;
            document.getElementById('login-logout-button').onclick = () => { location.reload(); };
        }
        
        // Re-apply draggable status to icons
        setupIconInteraction();
    }
    
    // --- Clock ---
    function updateClock() {
        const now = new Date();
        const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        document.getElementById('taskbar-time').textContent = timeString;
    }
    
    // --- Window Management ---
    function openWindow(winId) {
        const win = document.getElementById(winId);
        if (!win) return;
        
        win.style.display = 'flex';
        bringToFront(winId);

        if (!openWindows[winId]) {
             createTaskbarApp(winId);
        }
        openWindows[winId] = { minimized: false };
        updateTaskbar();
        startMenu.classList.remove('active');
    }
    
    function closeWindow(winId) {
        const win = document.getElementById(winId);
        if (win) win.style.display = 'none';
        
        delete openWindows[winId];
        if (activeWindow === winId) activeWindow = null;
        updateTaskbar();
    }

    function minimizeWindow(winId) {
        const win = document.getElementById(winId);
        if (win) win.style.display = 'none';

        if (openWindows[winId]) {
            openWindows[winId].minimized = true;
        }
        if (activeWindow === winId) activeWindow = null;
        updateTaskbar();
    }
    
    function maximizeWindow(winId) {
        const win = document.getElementById(winId);
        if (win) {
            win.classList.toggle('maximized');
            // If maximizing, remove inline styles that conflict
            if (win.classList.contains('maximized')) {
                 win.style.top = '';
                 win.style.left = '';
                 win.style.width = '';
                 win.style.height = '';
            }
        }
    }
    
    function bringToFront(winId) {
        if (activeWindow === winId) return;
        
        highestZIndex++;
        const win = document.getElementById(winId);
        if (win) {
            win.style.zIndex = highestZIndex;
            
            // If window was minimized, un-minimize it
            if (openWindows[winId] && openWindows[winId].minimized) {
                openWindows[winId].minimized = false;
                win.style.display = 'flex';
            }
        }
        
        activeWindow = winId;
        updateTaskbar();
    }
    
    function startDrag(e, element) {
        let offsetX = e.clientX - element.offsetLeft;
        let offsetY = e.clientY - element.offsetTop;

        function drag(e) {
            if (element.classList.contains('maximized')) return;
            element.style.left = `${e.clientX - offsetX}px`;
            element.style.top = `${e.clientY - offsetY}px`;
        }

        function stopDrag() {
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', stopDrag);
        }

        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', stopDrag);
    }
    
    // --- Taskbar ---
    function createTaskbarApp(winId) {
        const win = document.getElementById(winId);
        const title = win.querySelector('.title-bar-text').textContent;
        
        const app = document.createElement('button');
        app.className = 'taskbar-app';
        app.textContent = title;
        app.dataset.winId = winId;
        app.onclick = () => {
            bringToFront(winId);
        };
        taskbarApps.appendChild(app);
    }
    
    function updateTaskbar() {
        const apps = taskbarApps.querySelectorAll('.taskbar-app');
        apps.forEach(app => {
            const winId = app.dataset.winId;
            if (!openWindows[winId]) {
                app.remove();
                return;
            }
            
            if (winId === activeWindow && !openWindows[winId].minimized) {
                app.classList.add('active');
            } else {
                app.classList.remove('active');
            }
        });
    }

    // --- Desktop Icons ---
    function setupIconInteraction() {
        document.querySelectorAll('.icon').forEach(icon => {
            // Remove previous listeners to avoid duplicates
            const newIcon = icon.cloneNode(true);
            icon.parentNode.replaceChild(newIcon, icon);

            // Load position from localStorage
            const savedPos = localStorage.getItem(`iconpos_${newIcon.dataset.id}`);
            if (savedPos) {
                const { top, left } = JSON.parse(savedPos);
                newIcon.style.top = top;
                newIcon.style.left = left;
            }

            if (currentUser === correctUsername) {
                newIcon.classList.add('draggable');
                makeIconDraggable(newIcon);
            } else {
                newIcon.classList.remove('draggable');
            }
            
            // Add double click listener
            newIcon.addEventListener('dblclick', () => {
                const windowId = newIcon.dataset.windowId || `${newIcon.dataset.id}-window`;
                openWindow(windowId);
            });

            // Single click for selection style
            newIcon.addEventListener('click', (e) => {
                 e.stopPropagation();
                 document.querySelectorAll('.icon.selected').forEach(i => i.classList.remove('selected'));
                 newIcon.classList.add('selected');
            });
        });
        
        desktop.addEventListener('click', () => {
            document.querySelectorAll('.icon.selected').forEach(i => i.classList.remove('selected'));
        });
    }

    function makeIconDraggable(icon) {
        icon.addEventListener('mousedown', e => {
            e.preventDefault();
            e.stopPropagation();

            let offsetX = e.clientX - icon.offsetLeft;
            let offsetY = e.clientY - icon.offsetTop;

            function drag(e) {
                icon.style.left = `${e.clientX - offsetX}px`;
                icon.style.top = `${e.clientY - offsetY}px`;
            }

            function stopDrag() {
                localStorage.setItem(`iconpos_${icon.dataset.id}`, JSON.stringify({ top: icon.style.top, left: icon.style.left }));
                document.removeEventListener('mousemove', drag);
                document.removeEventListener('mouseup', stopDrag);
            }
            
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
        });
    }

    // --- Context Menu ---
    function showContextMenu(x, y, artworkId) {
        contextMenu.style.top = `${y}px`;
        contextMenu.style.left = `${x}px`;
        contextMenu.style.display = 'block';

        const deleteBtn = document.getElementById('context-delete');
        deleteBtn.onclick = () => {
            if (confirm("Are you sure you want to delete this artwork?")) {
                deleteArtwork(parseInt(artworkId));
            }
            contextMenu.style.display = 'none';
        };
    }

    // --- IndexedDB: Artworks ---
    function addArtwork() {
        const title = document.getElementById('artifact-title').value;
        const description = document.getElementById('artifact-desc').value;
        const imageFile = document.getElementById('artifact-image').files[0];
        
        if (!title || !description || !imageFile) {
            alert('Please fill all fields.');
            return;
        }

        const reader = new FileReader();
        reader.onloadend = () => {
            const artwork = { title, description, image: reader.result, date: new Date() };
            const transaction = db.transaction(['artworks'], 'readwrite');
            const store = transaction.objectStore('artworks');
            store.add(artwork);

            transaction.oncomplete = () => {
                alert('Artifact added!');
                closeWindow('add-artifact-window');
                loadArtworks();
            };
            transaction.onerror = (e) => console.error('Error adding artwork:', e);
        };
        reader.readAsDataURL(imageFile);
    }
    
    function loadArtworks() {
        // Clear existing dynamic icons and windows
        document.querySelectorAll('.icon[data-type="artwork"], .window[data-type="artwork"]').forEach(el => el.remove());
        document.getElementById('portfolio-content').innerHTML = '';
        
        const transaction = db.transaction(['artworks'], 'readonly');
        const store = transaction.objectStore('artworks');
        store.getAll().onsuccess = (e) => {
            const artworks = e.target.result;
            artworks.forEach(art => {
                createArtworkIcon(art);
                createArtworkWindow(art);
                createPortfolioEntry(art);
            });
            // Re-apply draggable status after adding new icons
            setupIconInteraction();
        };
    }

    function deleteArtwork(id) {
        const transaction = db.transaction(['artworks'], 'readwrite');
        const store = transaction.objectStore('artworks');
        store.delete(id);
        transaction.oncomplete = () => {
            loadArtworks();
            alert('Artwork deleted.');
        }
    }

    // --- IndexedDB: Blog ---
    function addBlogPost() {
         const title = document.getElementById('post-title').value;
         const content = document.getElementById('post-content').value;
         if (!title || !content) return;
         
         const post = { title, content, date: new Date().toISOString() };
         const transaction = db.transaction(['blogPosts'], 'readwrite');
         const store = transaction.objectStore('blogPosts');
         store.add(post);
         
         transaction.oncomplete = () => {
             alert('Post published!');
             closeWindow('add-post-window');
             loadBlogPosts();
         }
    }
    
    function loadBlogPosts() {
        const contentDiv = document.getElementById('blog-content');
        contentDiv.innerHTML = '';
        
        // Add "New Post" button for admin
        if (currentUser === correctUsername) {
            contentDiv.innerHTML += `<button onclick="openWindow('add-post-window')">Add New Post</button><hr>`;
        }
        
        const transaction = db.transaction(['blogPosts'], 'readonly');
        const store = transaction.objectStore('blogPosts');
        store.getAll().onsuccess = (e) => {
            const posts = e.target.result.reverse(); // Show newest first
            posts.forEach(post => {
                const postEl = document.createElement('div');
                postEl.className = 'blog-post';
                
                let deleteBtnHTML = '';
                if (currentUser === correctUsername) {
                     deleteBtnHTML = `<button style="float: right;" onclick="deleteBlogPost(${post.id})">Delete</button>`;
                }
                
                postEl.innerHTML = `
                    ${deleteBtnHTML}
                    <h3>${post.title}</h3>
                    <p class="date">${new Date(post.date).toLocaleDateString()}</p>
                    <p>${post.content.replace(/\n/g, '<br>')}</p>
                `;
                contentDiv.appendChild(postEl);
            });
        }
    }
    
    function deleteBlogPost(id) {
        if (!confirm('Are you sure you want to delete this post?')) return;

        const transaction = db.transaction(['blogPosts'], 'readwrite');
        const store = transaction.objectStore('blogPosts');
        store.delete(id);
        transaction.oncomplete = () => {
             loadBlogPosts();
        }
    }

    // --- Dynamic Element Creation ---
    function createArtworkIcon(art) {
        const icon = document.createElement('div');
        icon.className = 'icon';
        icon.dataset.id = art.id;
        icon.dataset.windowId = `artwork-window-${art.id}`;
        icon.dataset.type = 'artwork'; // Custom data attribute for identification
        icon.style.left = `${Math.random() * 400 + 120}px`;
        icon.style.top = `${Math.random() * 300 + 20}px`;

        icon.innerHTML = `
            <img src="https://win98icons.alexmeub.com/icons/png/paint_file-0.png" alt="Artwork">
            <p>${art.title}</p>
        `;
        desktop.appendChild(icon);
    }
    
    function createArtworkWindow(art) {
        const win = document.createElement('div');
        win.id = `artwork-window-${art.id}`;
        win.className = 'window';
        win.dataset.type = 'artwork';
        win.style.width = '600px';
        win.style.height = '450px';

        win.innerHTML = `
            <div class="title-bar">
                <div class="title-bar-text">${art.title}</div>
                <div class="title-bar-controls">
                    <button aria-label="Minimize"></button>
                    <button aria-label="Maximize"></button>
                    <button aria-label="Close"></button>
                </div>
            </div>
            <div class="window-body">
                <h2>${art.title}</h2>
                <img src="${art.image}" class="artwork-image" alt="${art.title}">
                <p>${art.description}</p>
            </div>
        `;
        document.body.appendChild(win);
        
        // Add event listeners to the new window's controls
        const controls = win.querySelector('.title-bar-controls');
        controls.querySelector('[aria-label="Close"]').addEventListener('click', () => closeWindow(win.id));
        controls.querySelector('[aria-label="Maximize"]').addEventListener('click', () => maximizeWindow(win.id));
        controls.querySelector('[aria-label="Minimize"]').addEventListener('click', () => minimizeWindow(win.id));
        win.querySelector('.title-bar').addEventListener('mousedown', (e) => {
            if (e.target.closest('.title-bar-controls')) return;
            startDrag(e, win);
            bringToFront(win.id);
        });
        win.addEventListener('mousedown', () => bringToFront(win.id));
    }
    
    function createPortfolioEntry(art) {
        const entry = document.createElement('div');
        entry.className = 'icon';
        entry.style.position = 'static';
        entry.style.margin = '10px';
        entry.ondblclick = () => openWindow(`artwork-window-${art.id}`);
        
        entry.innerHTML = `
            <img src="https://win98icons.alexmeub.com/icons/png/paint_file-0.png" alt="Artwork">
            <p>${art.title}</p>
        `;
        document.getElementById('portfolio-content').appendChild(entry);
    }
    
    // --- Applications ---
    function initPaint() {
        const canvas = document.getElementById('paint-canvas');
        const ctx = canvas.getContext('2d');
        let painting = false;

        function startPosition(e) {
            painting = true;
            draw(e);
        }
        function endPosition() {
            painting = false;
            ctx.beginPath();
        }
        function draw(e) {
            if (!painting) return;
            const rect = canvas.getBoundingClientRect();
            ctx.lineWidth = 5;
            ctx.lineCap = 'round';
            ctx.strokeStyle = 'black';
            ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }
        canvas.addEventListener('mousedown', startPosition);
        canvas.addEventListener('mouseup', endPosition);
        canvas.addEventListener('mousemove', draw);
    }
    
    function initPixelSweeper() {
        const boardEl = document.getElementById('minesweeper-board');
        const rows = 10, cols = 10, mines = 15;
        let board = [];
        
        boardEl.style.gridTemplateColumns = `repeat(${cols}, 20px)`;

        for (let r = 0; r < rows; r++) {
            board[r] = [];
            for (let c = 0; c < cols; c++) {
                const cell = document.createElement('div');
                cell.className = 'minesweeper-cell';
                cell.dataset.row = r;
                cell.dataset.col = c;
                boardEl.appendChild(cell);
                board[r][c] = { mine: false, revealed: false, flagged: false, neighbors: 0, el: cell };
            }
        }
        
        // Plant mines
        let minesPlanted = 0;
        while (minesPlanted < mines) {
            const r = Math.floor(Math.random() * rows);
            const c = Math.floor(Math.random() * cols);
            if (!board[r][c].mine) {
                board[r][c].mine = true;
                minesPlanted++;
            }
        }

        // Calculate neighbors
        for (let r = 0; r < rows; r++) {
            for (let c = 0; c < cols; c++) {
                if (board[r][c].mine) continue;
                let count = 0;
                for (let i = -1; i <= 1; i++) {
                    for (let j = -1; j <= 1; j++) {
                        if (i === 0 && j === 0) continue;
                        const nr = r + i, nc = c + j;
                        if (nr >= 0 && nr < rows && nc >= 0 && nc < cols && board[nr][nc].mine) {
                            count++;
                        }
                    }
                }
                board[r][c].neighbors = count;
            }
        }
        
        boardEl.addEventListener('click', e => {
            const cellEl = e.target.closest('.minesweeper-cell');
            if (cellEl) {
                const r = parseInt(cellEl.dataset.row);
                const c = parseInt(cellEl.dataset.col);
                revealCell(r, c);
            }
        });
        
        function revealCell(r, c) {
            if (r < 0 || r >= rows || c < 0 || c >= cols || board[r][c].revealed) return;
            
            const cell = board[r][c];
            cell.revealed = true;
            cell.el.classList.add('revealed');
            
            if (cell.mine) {
                cell.el.classList.add('mine');
                cell.el.innerHTML = '💣';
                alert("Game Over!");
                document.getElementById('error-sound').play();
                initPixelSweeper(); // Reset game
            } else if (cell.neighbors > 0) {
                cell.el.textContent = cell.neighbors;
                cell.el.classList.add(`color-${cell.neighbors}`);
            } else {
                 for (let i = -1; i <= 1; i++) {
                    for (let j = -1; j <= 1; j++) {
                        revealCell(r + i, c + j);
                    }
                }
            }
        }
    }
    
    </script>
</body>
</html>
